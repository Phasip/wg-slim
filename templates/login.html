{% extends "base.html" %}

{% block title %}Login - WireGuard Manager{% endblock %}

{% block content %}
<div class="row justify-content-center mt-5">
    <div class="col-md-4">
        <div class="card shadow">
            <div class="card-header text-center">
                <h4 class="mb-0"><i class="bi bi-shield-lock"></i> WG-Slim</h4>
            </div>
            <div class="card-body">
                <form id="login-form">
                    <input type="text" hidden name="username" autocomplete="username">
                    <div class="mb-3">
                        <label for="password" class="form-label">Password</label>
                        <input type="password" class="form-control" id="password" name="password" autocomplete="new-password" required autofocus>
                    </div>
                    <button type="submit" class="btn btn-wg w-100">
                        <i class="bi bi-box-arrow-in-right"></i> Login
                    </button>
                </form>
                    <div id="login-error" class="alert alert-danger mt-3 d-none" role="alert" aria-live="polite"></div>
                <script src="/static/js/openapi-client.js"></script>
                <script nonce="{{ csp_nonce }}">
                    (function() {
                        var form = document.getElementById('login-form');
                        form.addEventListener('submit', function(e) {
                            e.preventDefault();
                            var pwd = document.getElementById('password').value;
                            var errorDiv = document.getElementById('login-error');
                            
                            // Use the generated OpenAPI client exclusively
                            var cfg = new OpenApiClient.Configuration({ basePath: '/api', credentials: 'same-origin' });
                            var client = new OpenApiClient.DefaultApi(cfg);

                            client.loginPost({ loginRequest: { password: pwd } }).then(function(data) {
                                console.log('Login result:', data);
                                try {
                                    localStorage.setItem('wg_access_token', data.access_token);
                                    window.location.href = '/dashboard';
                                    return;
                                } catch (err) {
                                    // Update error div to show error
                                    console.error('Error processing login response:', err);
                                    errorDiv.textContent = 'Login error: ' + err.message;
                                    errorDiv.classList.remove('d-none');
                                }
                            }).catch(function(err) {
                                console.error('Login error:', err);
                                errorDiv.textContent = err.message;
                                errorDiv.classList.remove('d-none');
                            });
                        })
                    }());
                </script>
            </div>
        </div>
    </div>
</div>
{% endblock %}
